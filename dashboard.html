<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Valley Same-Day Dashboard</title>
<style>
body { font-family: Arial, sans-serif; background: #fff8f0; color: #333; margin: 0; padding: 20px; }
h1 { color: #ff7f11; text-align: center; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
th { background: #ff7f11; color: white; }
button { padding: 5px 10px; background: #ff7f11; color: white; border: none; cursor: pointer; border-radius: 3px; }
button:hover { background: #e76a00; }
input[type="file"] { margin-top: 5px; display: block; }
select { margin-top: 5px; }
</style>
</head>
<body>
<h1>Courier Dashboard</h1>

<table id="orders-table">
  <thead>
    <tr>
      <th>Tracking Ref</th>
      <th>Customer</th>
      <th>Status</th>
      <th>Driver</th>
      <th>POD Photo</th>
      <th>Signature</th>
      <th>Assign Driver</th>
      <th>Update Status / POD</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const API_BASE = 'https://api.valleysamedaytracking.delivery';
const authHeader = 'Basic ' + btoa('admin:Savana2010....'); // replace with your credentials

let onlineDrivers = [];

// Fetch online drivers from backend
async function loadDrivers() {
  try {
    const res = await fetch(`${API_BASE}/api/drivers`, { headers: { 'Authorization': authHeader } });
    onlineDrivers = await res.json();
  } catch (err) {
    console.error('Failed to load drivers:', err);
    onlineDrivers = [];
  }
}

// Load orders
async function loadOrders() {
  await loadDrivers();

  try {
    const res = await fetch(`${API_BASE}/api/orders`, { headers: { 'Authorization': authHeader } });
    const orders = await res.json();
    const tbody = document.querySelector('#orders-table tbody');
    tbody.innerHTML = '';

    orders.forEach(order => {
      const row = document.createElement('tr');

      let driverOptions = `<option value="">--Select Driver--</option>`;
      onlineDrivers.forEach(driver => {
        const selected = order.driverId === driver.id ? 'selected' : '';
        driverOptions += `<option value="${driver.id}" ${selected}>${driver.name}</option>`;
      });

      row.innerHTML = `
        <td>${order.ref}</td>
        <td>${order.name}</td>
        <td>${order.deliveryStatus || 'Waiting'}</td>
        <td>${order.driverId || ''}</td>
        <td>${order.podPhoto ? `<a href="${order.podPhoto}" target="_blank">View</a>` : ''}</td>
        <td>${order.podSignature ? `<a href="${order.podSignature}" target="_blank">View</a>` : ''}</td>
        <td>
          <select id="driver-${order.ref}">${driverOptions}</select>
          <button onclick="assignDriver('${order.ref}')">Assign</button>
        </td>
        <td>
          <select id="status-${order.ref}">
            <option value="Pending" ${order.deliveryStatus==='Pending'?'selected':''}>Pending</option>
            <option value="Assigned" ${order.deliveryStatus==='Assigned'?'selected':''}>Assigned</option>
            <option value="Out for Delivery" ${order.deliveryStatus==='Out for Delivery'?'selected':''}>Out for Delivery</option>
            <option value="Delivered" ${order.deliveryStatus==='Delivered'?'selected':''}>Delivered</option>
          </select>
          <input type="file" id="podPhoto-${order.ref}" accept="image/*">
          <input type="file" id="podSignature-${order.ref}" accept="image/*">
          <button onclick="updateOrder('${order.ref}')">Update</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  } catch (err) {
    console.error(err);
    alert('Failed to load orders.');
  }
}

// Assign driver
async function assignDriver(ref) {
  const driverId = document.getElementById(`driver-${ref}`).value;
  if (!driverId) return alert('Please select a driver');

  try {
    const res = await fetch(`${API_BASE}/api/assign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
      body: JSON.stringify({ ref, driverId })
    });
    const data = await res.json();
    if (data.success) alert(`Driver assigned: ${driverId}`);
    loadOrders();
  } catch (err) {
    console.error(err);
    alert('Failed to assign driver.');
  }
}

// Update status / POD
async function updateOrder(ref) {
  const status = document.getElementById(`status-${ref}`).value;
  const podPhoto = document.getElementById(`podPhoto-${ref}`).files[0];
  const podSignature = document.getElementById(`podSignature-${ref}`).files[0];

  const formData = new FormData();
  formData.append('ref', ref);
  formData.append('status', status);
  if (podPhoto) formData.append('podPhoto', podPhoto);
  if (podSignature) formData.append('podSignature', podSignature);

  try {
    const res = await fetch(`${API_BASE}/api/status`, { method: 'POST', headers: { 'Authorization': authHeader }, body: formData });
    const data = await res.json();
    if (data.success) alert('Order updated successfully.');
    loadOrders();
  } catch (err) {
    console.error(err);
    alert('Failed to update order.');
  }
}

// Initial load
loadOrders();
</script>
</body>
</html>
